<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Buscador de Cartas MTG</title>
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <div class="autocomplete">
        <input type="text" id="search" placeholder="Ej: black lotus" />
        <button id="searchBtn" title="Buscar">&#128269;</button>
        <div id="suggestions" class="suggestions"></div>
    </div>

    <div id="cardsSelected">
        <h3>Cartas seleccionadas</h3>
    </div>

    <div id="cardLibrary">
        <h3>Biblioteca</h3>
    </div>

    <div id="previewImg" class="preview-img"></div>

    <!-- Capa de fondo oscurecida -->
    <div id="overlay"></div>

    <div id="importModal">
        <h3>Importar Biblioteca</h3>
        <select id="importOption">
            <option value="">Selecciona una opción...</option>
            <option value="csv">Desde fichero CSV</option>
            <option value="sheets">Desde Google Sheets</option>
        </select>
        <div id="csvUpload" style="margin-top: 1rem; display: none;">
            <input type="file" id="csvFileInput" accept=".csv" />
        </div>
        <div id="sheetsInput" style="margin-top: 1rem; display: none;">
            <input type="text" id="sheetUrl" placeholder="Pega el enlace de Google Sheets" />
            <button id="loadBtn" onclick="loadFromGoogleSheets()">Cargar</button>
        </div>
        <!-- Botón cancelar -->
        <button id="cancelBtn">Cancelar</button>
    </div>

    <script>
        // Estado global
        const state = {
            cardsOwned: {},
            cardsInStage: {},
            cardsDataCache: {},
            decks: {}
        };

        // Referencias DOM
        const dom = {
            input: document.getElementById("search"),
            suggestionsBox: document.getElementById("suggestions"),
            searchBtn: document.getElementById("searchBtn"),
            previewImg: document.getElementById("previewImg"),
            cardsSelected: document.getElementById("cardsSelected"),
            cardLibrary: document.getElementById("cardLibrary"),
            overlay: document.getElementById("overlay"),
            importModal: document.getElementById("importModal"),
            cancelBtn: document.getElementById("cancelBtn"),
            saveCsvBtn: document.getElementById("saveCsvBtn")
        };

        // Búsqueda de sugerencias
        async function fetchSuggestions(query) {
            const url = `https://api.scryfall.com/cards/autocomplete?q=${encodeURIComponent(query)}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        }

        async function fetchCardData(name) {
            if (state.cardsDataCache[name]) return state.cardsDataCache[name];
            const url = `https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(name)}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.json();
            state.cardsDataCache[name] = data;
            return data;
        }

        async function handleSearch() {
            const query = dom.input.value.trim();
            if (!query) return clearSuggestions();

            try {
                const { data: suggestions } = await fetchSuggestions(query);
                renderSuggestions(suggestions);
            } catch (err) {
                console.error("Error al obtener sugerencias:", err);
                dom.suggestionsBox.innerHTML = "<div style='padding: 8px; color: red;'>Error al cargar sugerencias</div>";
            }
        }



        function renderSuggestions(suggestions) {
            dom.suggestionsBox.innerHTML = "";

            suggestions.forEach(suggestion => {
                const div = document.createElement("div");
                div.className = "suggestion";
                div.textContent = `${suggestion} (${state.cardsOwned[suggestion] ? state.cardsOwned[suggestion].length : 0})`;

                if (state.cardsInStage[suggestion]) {
                    div.style.backgroundColor = "#ddd";
                    div.style.cursor = "not-allowed";
                }

                div.onclick = () => {
                    dom.previewImg.style.display = "none";
                    addCard(suggestion);
                    clearSuggestions();
                };

                div.onmouseover = () => {
                    showPreview(suggestion);
                }

                dom.suggestionsBox.appendChild(div);
            });
        }

        function clearSuggestions() {
            dom.suggestionsBox.innerHTML = "";
        }

        var clearPreview = null;

        async function showPreview(name) {
            try {
                const data = await fetchCardData(name);
                if (data.image_uris) {
                    const img = document.createElement("img");
                    img.src = data.image_uris.normal;
                    img.style.maxWidth = "200px";
                    img.style.maxHeight = "300px";

                    dom.previewImg.innerHTML = "";
                    dom.previewImg.appendChild(img);
                    dom.previewImg.style.display = "block";

                    if (!clearPreview) {
                        clearPreview = (e) => {
                            if (e.target.closest(".suggestion") === null) {
                                dom.previewImg.style.display = "none";
                                document.body.removeEventListener("mouseover", clearPreview);
                                clearPreview = null;
                            }
                        };
                        document.body.addEventListener("mouseover", clearPreview);
                    }

                }
            } catch (err) {
                console.error("Error al mostrar la imagen de la carta:", err);
                dom.previewImg.style.display = "none";
            }
        }

        async function addCard(name) {
            if (state.cardsInStage[name]) return;  // No agregar si ya está en el stage.

            try {
                const cardData = await fetchCardData(name);
                state.cardsInStage[name] = cardData;

                const cardDiv = document.createElement("div");
                cardDiv.className = "card-preview";
                cardDiv.id = `card-${name}`;

                const cardInfoContainer = document.createElement("div");
                cardInfoContainer.className = "card-info-container";

                const cardTableContainer = document.createElement("div");
                cardTableContainer.id = `table-${name}`;
                cardTableContainer.className = "card-table-container";

                const title = document.createElement("h4");
                title.textContent = cardData.name;

                const img = document.createElement("img");
                img.src = cardData.image_uris.normal;
                img.style.maxWidth = "100px";
                img.style.maxHeight = "150px";

                const inputWrapper = document.createElement("div");
                inputWrapper.style.display = "flex";
                inputWrapper.style.alignItems = "center";

                const minusBtn = document.createElement("button");
                minusBtn.textContent = "-";
                minusBtn.onclick = () => removeCardFromLibrary(name);

                const input = document.createElement("input");
                input.type = "number";
                input.value = state.cardsOwned[name] ? state.cardsOwned[name].length : 0;
                input.style.width = "40px";
                input.disabled = true;

                const plusBtn = document.createElement("button");
                plusBtn.textContent = "+";
                plusBtn.onclick = () => addCardToLibrary(name);

                inputWrapper.appendChild(minusBtn);
                inputWrapper.appendChild(input);
                inputWrapper.appendChild(plusBtn);

                cardInfoContainer.appendChild(title);
                cardInfoContainer.appendChild(img);
                cardInfoContainer.appendChild(inputWrapper);

                cardDiv.appendChild(cardInfoContainer);
                if (state.cardsOwned[name] && state.cardsOwned[name].length > 0) {
                    const table = document.createElement("table");
                    table.className = "card-table";
                    const thead = document.createElement("thead");
                    thead.innerHTML = "<tr><th>ID</th><th>Deck</th><th></th></tr>";
                    table.appendChild(thead);

                    const tbody = document.createElement("tbody");

                    if (state.cardsOwned[name]) {
                        state.cardsOwned[name].forEach((cardObj, index) => {
                            const row = document.createElement("tr");

                            const idCell = document.createElement("td");
                            idCell.textContent = cardObj.id;

                            const deckCell = document.createElement("td");
                            deckCell.textContent = cardObj.deck || "(ninguna)";
                            deckCell.style.cursor = "pointer";
                            deckCell.style.color = "blue";
                            deckCell.onclick = () => showDeckSelector(name, index, deckCell);

                            const removeCell = document.createElement("td");
                            const removeBtn = document.createElement("button");
                            removeBtn.textContent = "X";
                            removeBtn.onclick = () => {

                                const eliminar = true;
                                if (cardObj.deck) {
                                    eliminar = confirm(`¿Estás seguro de que deseas eliminar la carta "${cardObj.name}"?`);
                                }

                                if (eliminar) {
                                    removeCardFromLibrary(name);
                                    row.remove();
                                }
                            };
                            removeCell.appendChild(removeBtn);

                            row.appendChild(idCell);
                            row.appendChild(deckCell);
                            row.appendChild(removeCell);
                            tbody.appendChild(row);
                        });
                    }

                    table.appendChild(tbody);
                    cardTableContainer.appendChild(table);

                }

                cardDiv.appendChild(cardTableContainer);

                dom.cardsSelected.appendChild(cardDiv);
            } catch (err) {
                console.error("Error al agregar la carta:", err);
            }
        }

        function addCardToLibrary(name) {
            const newCard = { id: Date.now(), name: name, deck: null };
            if (!state.cardsOwned[name]) state.cardsOwned[name] = [];
            state.cardsOwned[name].push(newCard);

            updateCardCountInStage(name);
            renderCardTable(name); // <--- NUEVO
        }

        function removeCardFromLibrary(name) {
            const cards = state.cardsOwned[name];
            if (!cards || cards.length === 0) return;

            // Buscar una carta sin deck
            const index = cards.findIndex(card => !card.deck);

            if (index !== -1) {
                cards.splice(index, 1); // Eliminar la carta sin deck
            } else {
                // Si todas tienen deck, confirmar antes de eliminar la primera
                const card = cards[0];
                const confirmar = confirm(`La carta "${name}" está asociada a la deck "${card.deck}". ¿Deseas eliminarla de todas formas?`);
                if (!confirmar) return;
                cards.shift(); // Eliminar la primera
            }

            updateCardCountInStage(name);
            renderCardTable(name);
        }

        function updateCardCountInStage(name) {
            const cardDiv = document.getElementById(`card-${name}`);
            if (!cardDiv) return;

            const input = cardDiv.querySelector("input");
            input.value = state.cardsOwned[name] ? state.cardsOwned[name].length : 0;
        }

        function renderCardTable(name) {
            const tableDiv = document.getElementById(`table-${name}`);
            if (!tableDiv) return;

            const oldTable = tableDiv.querySelector("table");
            if (oldTable) tableDiv.removeChild(oldTable);

            if (state.cardsOwned[name] && state.cardsOwned[name].length > 0) {
                const table = document.createElement("table");
                table.className = "card-table";
                const thead = document.createElement("thead");
                thead.innerHTML = "<tr><th>ID</th><th>Deck</th><th</th></tr>";
                table.appendChild(thead);

                const tbody = document.createElement("tbody");

                if (state.cardsOwned[name]) {
                    state.cardsOwned[name].forEach((cardObj, index) => {
                        const row = document.createElement("tr");

                        const idCell = document.createElement("td");
                        idCell.textContent = cardObj.id;

                        const deckCell = document.createElement("td");
                        deckCell.textContent = cardObj.deck || "(ninguna)";
                        deckCell.style.cursor = "pointer";
                        deckCell.style.color = "blue";
                        deckCell.onclick = () => showDeckSelector(name, index, deckCell);

                        const removeCell = document.createElement("td");
                        const removeBtn = document.createElement("button");
                        removeBtn.textContent = "X";
                        removeBtn.onclick = () => {

                            const eliminar = true;
                            if (cardObj.deck) {
                                eliminar = confirm(`¿Estás seguro de que deseas eliminar la carta "${cardObj.name}"?`);
                            }

                            if (eliminar) {
                                removeCardFromLibrary(name);
                                row.remove();
                            }
                        };
                        removeCell.appendChild(removeBtn);

                        row.appendChild(idCell);
                        row.appendChild(deckCell);
                        row.appendChild(removeCell);
                        tbody.appendChild(row);
                    });
                }

                table.appendChild(tbody);
                tableDiv.appendChild(table);
            }
        }

        function showDeckSelector(cardName, cardIndex, deckCell) {
            const existingPopup = document.querySelector(".deck-popup");
            if (existingPopup) existingPopup.remove();

            const selector = document.createElement("div");
            selector.className = "deck-popup";
            selector.style.position = "absolute";
            selector.style.background = "white";
            selector.style.border = "1px solid #ccc";
            selector.style.padding = "8px";
            selector.style.zIndex = 1000;

            const rect = deckCell.getBoundingClientRect();
            selector.style.top = `${rect.bottom + window.scrollY}px`;
            selector.style.left = `${rect.left + window.scrollX}px`;

            const decks = Object.keys(state.decks);

            const noneOption = document.createElement("div");
            noneOption.textContent = "(ninguna)";
            noneOption.style.cursor = "pointer";
            noneOption.style.padding = "4px";
            noneOption.onclick = (e) => {
                e.stopPropagation();
                state.cardsOwned[cardName][cardIndex].deck = null;
                deckCell.textContent = "(ninguna)";
                selector.remove();
            };
            selector.appendChild(noneOption);


            decks.forEach(deckName => {
                const option = document.createElement("div");
                option.textContent = deckName;
                option.style.cursor = "pointer";
                option.style.padding = "4px";
                option.onclick = (e) => {
                    e.stopPropagation();
                    state.cardsOwned[cardName][cardIndex].deck = deckName;
                    deckCell.textContent = deckName;
                    selector.remove();
                };
                selector.appendChild(option);
            });

            // Opción para crear nueva deck
            const newDeckOption = document.createElement("div");
            newDeckOption.textContent = "➕ Crear nueva deck…";
            newDeckOption.style.cursor = "pointer";
            newDeckOption.style.color = "green";
            newDeckOption.style.padding = "4px";
            newDeckOption.onclick = (e) => {
                e.stopPropagation();  // Detener la propagación para evitar que el clic cierre el selector
                const newDeckName = prompt("Nombre de la nueva deck:");
                if (newDeckName) {
                    state.decks[newDeckName] = true; // Puedes cambiar esto según tu estructura
                    state.cardsOwned[cardName][cardIndex].deck = newDeckName;
                    deckCell.textContent = newDeckName;
                }
                selector.remove();
            };
            selector.appendChild(newDeckOption);

            document.body.appendChild(selector);

            // Evitar el cierre del selector si se hace clic dentro
            setTimeout(() => {
                function handleClickOutside(event) {
                    // Verificamos que el selector todavía exista y que el clic fue fuera de él
                    if (selector && !selector.contains(event.target)) {
                        selector.remove();
                        document.removeEventListener("click", handleClickOutside);
                    }
                }

                document.addEventListener("click", handleClickOutside);
            }, 0);
        }

        // Control del menú desplegable
        document.getElementById("importOption").addEventListener("change", (e) => {
            document.getElementById("csvUpload").style.display = "none";
            document.getElementById("sheetsInput").style.display = "none";

            if (e.target.value === "csv") {
                document.getElementById("csvUpload").style.display = "block";
            } else if (e.target.value === "sheets") {
                document.getElementById("sheetsInput").style.display = "block";
            }
        });

        // Cargar CSV
        document.getElementById("csvFileInput").addEventListener("change", function () {
            const file = this.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const cards = {};
                const text = e.target.result;
                const lines = text.split("\n").map(line => line.trim()).filter(line => line.length > 0);
                lines.forEach(line => {
                    const [name, id, deck] = line.split(",");
                    const trimmedName = name?.trim();
                    if (!trimmedName) return;
                    if (!cards[trimmedName]) cards[trimmedName] = [];
                    var card = { id: parseInt(id), name: trimmedName, deck: deck?.trim() || null };
                    if (card.deck == '(ninguna)') card.deck = null;
                    cards[trimmedName].push(card);
                });

                state.cardsOwned = cards;

                Object.values(cards).forEach(cardArray => {
                    cardArray.forEach(card => {
                        if (card.deck && !state.decks[card.deck]) {
                            state.decks[card.deck] = true;
                        }
                    });
                });

                document.getElementById("importModal").style.display = "none";

                renderLibraryTable();
            };
            reader.readAsText(file);
        });

        // Simulación básica para cargar desde Google Sheets
        function loadFromGoogleSheets() {
            const url = document.getElementById("sheetUrl").value.trim();
            if (!url) return alert("Proporciona un enlace válido.");

            alert("Función de Google Sheets aún no implementada.");
        }

        function saveCardsToCSV() {
            const cardsOwnedArray = Object.keys(state.cardsOwned).map(cardName => {
                const cardData = state.cardsOwned[cardName];
                return cardData.map(card => `${card.id},${card.name},${card.deck || "(ninguna)"}`).join("\n");
            }).join("\n");

            const csvContent = cardsOwnedArray;

            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "cartas_seleccionadas.csv");
                link.style.visibility = "hidden";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Inicializar el estado de las cartas seleccionadas
        function renderLibraryTable() {
            dom.cardLibrary.innerHTML = "<h3>Cartas seleccionadas</h3>";
            var table = document.createElement("table");
            table.className = "card-table";
            var thead = document.createElement("thead");
            thead.innerHTML = "<tr><th>Nombre</th><th>Imagen</th></tr>";
            table.appendChild(thead);
            var tbody = document.createElement("tbody");

            for (const cardName in state.cardsOwned) {
                const cardArray = state.cardsOwned[cardName];

                cardArray.forEach(card => {
                    const row = document.createElement("tr");
                    const nameCell = document.createElement("td");
                    nameCell.textContent = card.name;

                    const deckCell = document.createElement("td");
                    deckCell.textContent = card.deck || "(ninguna)";
                    deckCell.style.cursor = "pointer";
                    deckCell.style.color = "blue";
                    deckCell.onclick = () => showDeckSelector(card.name, card.id, deckCell);

                    row.appendChild(nameCell);
                    row.appendChild(deckCell);
                    tbody.appendChild(row);
                });

            }
            table.appendChild(tbody);
            dom.cardLibrary.appendChild(table);

        }

        // Eventos
        dom.input.addEventListener("input", () => {
            dom.input.value.endsWith(" ") ? handleSearch() : clearSuggestions();
        });

        dom.input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                handleSearch();
            }
        });

        dom.searchBtn.addEventListener("click", handleSearch);

        document.addEventListener("click", (e) => {
            if (!e.target.closest(".autocomplete")) clearSuggestions();
        });

        document.addEventListener("mousemove", (e) => {
            dom.previewImg.style.left = `${e.pageX + 10}px`;
            dom.previewImg.style.top = `${e.pageY + 10}px`;
        });

        // Función para mostrar el modal
        function showImportModal() {
            dom.overlay.style.display = "block";
            dom.importModal.style.display = "block";
        }

        // Función para cerrar el modal
        function closeImportModal() {
            dom.overlay.style.display = "none";
            dom.importModal.style.display = "none";
        }

        // Mostrar modal al cargar la página
        window.addEventListener("load", () => {
            if (Object.keys(state.cardsOwned).length === 0) {
                showImportModal();
            }
        });

        // Cerrar modal al hacer click en el overlay
        dom.overlay.addEventListener("click", closeImportModal);

        // Cerrar modal al hacer click en el botón "Cancelar"
        dom.cancelBtn.addEventListener("click", closeImportModal);

        // Guardar CSV
        dom.saveCsvBtn.addEventListener("click", saveCardsToCSV);
    </script>
</body>

</html>